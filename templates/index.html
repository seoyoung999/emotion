<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ì±Œë¦°ì§€ ì¶”ì²œê¸°</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    /* ì±—ë´‡ ìŠ¤íƒ€ì¼ */
    #chatbot {
      display: {{ 'block' if show_chatbot else 'none' }};
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      height: 400px;
      border: 1px solid #ddd;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      padding: 10px;
      overflow: auto;
      font-size: 14px;
      z-index: 1000;
    }
    #chatbot-messages {
      height: 320px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 5px;
    }
    #chatbot-input {
      width: calc(100% - 50px);
      padding: 5px;
    }
    #chatbot-send {
      width: 40px;
    }
    .user-msg { color: blue; }
    .bot-msg { color: green; }
  </style>
</head>
<body>
  <h2>ì˜¤ëŠ˜ì˜ ê°ì • ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
  <div class="form-wrapper">
    <form method="POST" action="/analyze">
      <label>ê°ì • ì¹´í…Œê³ ë¦¬:</label>
      <select id="emotion-category" required>
        <option value="">-- ê°ì • ë¶„ë¥˜ ì„ íƒ --</option>
        <option value="Positive">ê¸ì •</option>
        <option value="Neutral">ì¤‘ë¦½</option>
        <option value="Negative">ë¶€ì •</option>
      </select>

      <label>ì„¸ë¶€ ê°ì •:</label>
      <select name="feeling_text" id="feeling_text" required>
        <option value="">-- ì„¸ë¶€ ê°ì • ì„ íƒ --</option>
      </select>

      <label>ê¸°ë¶„ ì ìˆ˜ (0~10):</label>
      <input type="number" name="mood" min="0" max="10" required />

      <label>ìˆ˜ë©´ ì‹œê°„ (ì‹œê°„):</label>
      <input type="number" name="sleep" min="0" max="24" required />

      <label>ì˜¤ëŠ˜ í™œë™ëŸ‰ (0~10):</label>
      <input type="number" name="activity" min="0" max="10" required />

      <label>ê´€ì‹¬ì‚¬ (ì˜ˆ: ê·¸ë¦¼, ì‚°ì±…, ê¸€ì“°ê¸° ë“±):</label>
      <input type="text" name="interest" required />

      <!-- ğŸ‘‡ bad_score íˆë“  í•„ë“œ -->
      <input type="hidden" name="bad_score" id="bad_score" value="0" />

      <input type="submit" value="ë¶„ì„í•˜ê³  ì±Œë¦°ì§€ ì¶”ì²œë°›ê¸°" />
    </form>
  </div>

  <!-- âœ… ì±—ë´‡ UI -->
  <div id="chatbot">
    <div style="text-align: right;">
      <button onclick="document.getElementById('chatbot').style.display='none'" style="border: none; background: none; font-size: 16px; cursor: pointer;">âŒ</button>
    </div>
    <div id="chatbot-messages"></div>
    <input type="text" id="chatbot-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="chatbot-send">ì „ì†¡</button>
  </div>

  <script>
    // âœ… ê°ì • ì¹´í…Œê³ ë¦¬ - ì„¸ë¶€ ê°ì • ì—°ê²°
    const emotionMap = {
      Positive: ["í–‰ë³µ", "ì¦ê±°ì›€", "ê¸°ì¨", "ì‚¬ë‘", "ì„¤ë ˜", "ê°ì‚¬", "ì‹ ë‚¨", "í¸ì•ˆí•¨", "í¬ë§ì ", "ì¢‹ì€ í•˜ë£¨", "ê¸°ë¶„ ìµœê³ "],
      Neutral: ["ë³´í†µ", "í‰ë²”í•¨", "ë¬´ë¤ë¤", "ë¬´ë‚œí•¨", "ê·¸ëƒ¥ ê·¸ë˜", "ì¼ìƒì ", "í‰ì˜¨í•¨"],
      Negative: ["ìŠ¬í””", "ìš°ìš¸", "í™”ë‚¨", "ë‹µë‹µí•¨", "ë¶ˆì•ˆ", "ì™¸ë¡œì›€", "í”¼ê³¤í•¨", "ìŠ¤íŠ¸ë ˆìŠ¤", "ê±±ì •", "ì†ìƒí•¨", "í˜ë“  í•˜ë£¨"]
    };

    document.getElementById('emotion-category').addEventListener('change', function () {
      const category = this.value;
      const feelingSelect = document.getElementById('feeling_text');
      feelingSelect.innerHTML = '<option value="">-- ì„¸ë¶€ ê°ì • ì„ íƒ --</option>';
      if (emotionMap[category]) {
        emotionMap[category].forEach(feeling => {
          const opt = document.createElement('option');
          opt.value = feeling;
          opt.textContent = feeling;
          feelingSelect.appendChild(opt);
        });
      }
    });

    // âœ… ë¶€ì • ê°ì •ì´ë©´ bad_score=1ë¡œ ì„¤ì •
    document.querySelector('form').addEventListener('submit', function () {
      const category = document.getElementById('emotion-category').value;
      document.getElementById('bad_score').value = category === 'Negative' ? "1" : "0";
    });

    // âœ… ì±—ë´‡ ë™ì‘
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');

    function appendMessage(text, className) {
      const p = document.createElement('p');
      p.textContent = text;
      p.className = className;
      chatbotMessages.appendChild(p);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    chatbotSend.addEventListener('click', () => {
      const message = chatbotInput.value.trim();
      if (!message) return;
      appendMessage("ë‚˜: " + message, 'user-msg');
      chatbotInput.value = '';

      fetch('/chatbot', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message})
      })
      .then(res => res.json())
      .then(data => {
        appendMessage("ì±—ë´‡: " + data.response, 'bot-msg');
      });
    });

    // âœ… ì±—ë´‡ì´ ë³´ì¼ ê²½ìš° ì²« ì§ˆë¬¸ ìë™ ì¶œë ¥
    window.onload = () => {
      const showChatbot = {{ 'true' if show_chatbot else 'false' }};
      if (showChatbot === true) {
        document.getElementById("chatbot").style.display = "block";

        fetch('/chatbot', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: ''})
        })
        .then(res => res.json())
        .then(data => {
          appendMessage("ì±—ë´‡: " + data.response, 'bot-msg');
        });
      }
    };
  </script>
</body>
</html>
